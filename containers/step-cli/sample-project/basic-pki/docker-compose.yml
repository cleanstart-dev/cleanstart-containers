networks:
  pki:
    driver: bridge
 
volumes:
  step_secrets:
    driver: local
  step_certs:
    driver: local
 
services:
  # Step CLI for certificate operations
  step-cli:
    image: cleanstart/step-cli:latest
    container_name: step-cli-basic
    restart: unless-stopped
    volumes:
      - step_secrets:/app/secrets
      - step_certs:/app/certs
      - ./scripts:/app/scripts
      - ./config:/app/config
    environment:
      - STEPPATH=/app/secrets
      - STEP_CA_URL=https://step-ca:443
    networks:
      - pki
    depends_on:
      - step-ca
    entrypoint: ["/bin/busybox", "sh", "-c"]
    command: ["while true; do sleep 30; done"]  # Keep container running
    healthcheck:
      test: ["CMD", "/step", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
 
  # Step CA server
  step-ca:
    image: cleanstart/step-cli:latest
    container_name: step-ca-basic
    restart: unless-stopped
    ports:
      - "443:443"
    volumes:
      - step_secrets:/app/secrets
      - ./ca-config:/app/ca-config
    environment:
      - STEPPATH=/app/secrets
    networks:
      - pki
    entrypoint: ["/bin/busybox", "sh", "-c"]
    command: ["while true; do sleep 30; done"]  # Keep container running
    healthcheck:
      test: ["CMD", "/step", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
 
  # Certificate generator service
  cert-generator:
    image: cleanstart/python:latest
    container_name: cert-generator-basic
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - step_certs:/app/certs
      - ./cert-generator:/app
    networks:
      - pki
    depends_on:
      - step-ca
    entrypoint: ["/bin/busybox", "sh", "-c"]
    command: ["pip install flask requests && python3 /app/cert_generator.py"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
 
  # Certificate inspector service
  cert-inspector:
    image: cleanstart/nginx:latest
    container_name: cert-inspector-basic
    restart: unless-stopped
    ports:
      - "8082:80"
    volumes:
      - step_certs:/usr/share/nginx/html/certs
      - ./inspector:/usr/share/nginx/html
    networks:
      - pki
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3